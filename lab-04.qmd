---
title: "lab 4 data visualization"
author: "Hanna Fei"
format: html
editor: visual
embed-resources: true
---

## 1. Read in data

```{r}

if (!file.exists("covid_processed.csv"))
  download.file(
    url = "https://raw.githubusercontent.com/dmcable/BIOSTAT620W26/main/data/covid/covid_processed.csv",
    destfile = "covid_processed.csv",
    method   = "libcurl",
    timeout  = 60
    )

covid <- read.csv("covid_processed.csv")
library(dplyr)
library(lubridate)
library(ggplot2)
```

## 2. Prepare the data

```{r}
covid <- covid %>% 
  mutate(norm_cases = (cases / pop)*100000,
         norm_hosp = (hosp / pop)*100000,
         norm_booster = (booster / pop)*100000,
         norm_series = (series / pop)*100000,
         norm_deaths = (deaths / pop)*100000,
         date = ymd(date))

covid_avg <- covid %>% 
  summarize(state_name = first(state_name),
            region = first(region),
            region_name = first(region_name),
            pop = mean(pop),
            cases = mean(norm_cases, na.rm = TRUE),
            hosp = mean(norm_hosp, na.rm = TRUE),
            booster = mean(norm_booster, na.rm = TRUE),
            series = mean(norm_series, na.rm = TRUE),
            deaths = mean(norm_deaths, na.rm = TRUE),
            .by = state)

# binary variable for population
covid_avg <- covid_avg %>% 
  mutate(pop_size = ifelse(pop > 10000000, "high", "low"))

# region as factor
covid_avg$region <- as.factor(covid_avg$region)
```

## 3. **Use geom_violin to examine the case rates and death rates by region**

You saw how to use `geom_boxplot` in class. Try using `geom_violin` instead (take a look at the help). (hint: you will need to set the `x` aesthetic to 1)

-   Use facets

-   Fill color by region

-   Describe what you observe in the graph

```{r}
covid_avg[!is.na(covid_avg$cases), ] %>% 
  ggplot() +
  geom_violin(mapping = aes(x = 1, y = cases, fill = region_name)) +
  facet_wrap(~ region_name, nrow = 2) +
  labs(title = "Case Rate by Region", x = "", y = "Cases per 100000 People")+
  theme(legend.position = "none")

ggplot(covid_avg[!is.na(covid_avg$deaths), ]) +
geom_violin(mapping = aes(x = 1, y = deaths, fill = region_name)) +
facet_wrap(~ region_name, nrow = 2) +
labs(title = "Death Rate by Region", x = "", y = "Deaths per 100000 People") +
  theme(legend.position = "none")
```

In the violin plots for case rates and death rates by region, the case and death rates are linearly related. States with higher case rates also had higher death rates and vice versa.

### **4. Use `geom_point` with `stat_smooth` to examine the association between time and case rates by region**

-   Filter the data over time to two weeks after the first date in the dataset

-   Color points by region

-   Fit a function with `stat_smooth` by region. Does `method=lm` or the default method work better?

-   For the default `stat_smooth`, play around with the `span` parameter to get a smooth that fits the data better without being too noisy.

-   Describe what you observe in the graph

```{r}
first_date = min(covid$date, na.rm = TRUE)
two_weeks = first_date + days(14)

covid_filter <- covid %>% 
  filter(date >= two_weeks)

ggplot(data = covid_filter) +
  geom_point(mapping = aes(x = date, y = norm_cases, color = region_name, alpha = 0.5)) +
  stat_smooth(mapping = aes(x = date, y = norm_cases),
              method = "lm") +
  labs(y = "cases per 100000")

ggplot(data = covid_filter) +
  geom_point(mapping = aes(x = date, y = norm_cases, color = region_name, alpha = 0.5)) +
  stat_smooth(mapping = aes(x = date, y = norm_cases),
              method = "loess",
              span = 0.2) +
  labs(y = "cases per 100000")
```

The default method works better to fit the data to match the variation and peaks in the data. The lm method creates a linear line, but the data in not linear so it does not give much information. Using a span of 0.2 is ideal because the line does not have too much noise, but still summarizes the data well and catches smaller peaks. From this graph, we can see that there is a large peak at the end of 2020, and at the end of the dataset during January 2022, the case rates are increasing.

### **5. Use `geom_bar` to create barplots of the states by population category colored by region**

-   Bars by population category using `position="dodge"`

-   Change colors from the default. Color by region using `scale_fill_brewer` see [this](http://rstudio-pubs-static.s3.amazonaws.com/5312_98fc1aba2d5740dd849a5ab797cc2c8d.html)

-   Create nice labels on the axes and add a title

-   Describe what you observe in the graph

```{r}
ggplot(data = covid_avg) +
  geom_bar(mapping = aes(x = pop_size, fill = region_name), position = "dodge") + 
  scale_fill_brewer(palette = "Paired") +
  labs(title = "Number of States by Population Size and Region",
       x = "Population Size",
       y = "Number of States",
       fill = "Region")
```

In this chart we can observe the number of states that are considered high and low population for each region. We can see that there are fewer states with a high population and more states with a low population for most regions. The regions that had the most high population states were in the Southeast and Midwest regions.

### **6. Use `stat_summary` to examine mean vaccination rate and death rate by region with standard deviation error bars**

-   Use `fun.data="mean_sdl"` in `stat_summary`. Look up what `mean_sdl` does.

-   Add another layer of `stats_summary` but change the geom to `"errorbar"` (see the help).

-   Describe the graph and what you observe

```{r}
ggplot(data = covid_avg, aes(x = region, y = series)) +
  stat_summary(fun.data = "mean_sdl") +
  stat_summary(geom = "errorbar") +
  labs(title = "Mean Vaccination Rates by Region", x = "Region", y = "Vaccination Rate per 100,000")

ggplot(data = covid_avg, aes(x = region, y = deaths)) +
  stat_summary(fun.data = "mean_sdl") + 
  stat_summary(geom = "errorbar") + 
  labs(title = "Mean Death Rates by Region", x = "Region", y = "Death Rate per 100,000")
```

Vaccination rates and death rates are inversely related. Regions with lower vaccination rates have higher death rates, and regions with higher vaccination rates have lower death rates.

### **7. Make a map showing the spatial trend in COVID deaths in the US**

-   Use `geom_polygon` and `map_data`. Modify the given code.

-   Merge the `map_data` data.frame with your COVID data.frame to add in the COVID data to the map data. Hint: use `left_join`.

-   Use a color palette with custom colors

-   Make sure that your legend is labelled correctly.

-   Add a \* or other label for the top 10 states in highest death rate.

-   Make sure that the aspect ratio is appropriate

-   Describe your observations

-   Describe the trend in COVID death rates across the US

```{r}
us_map <- map_data("state")

# turn state names to lowercase
covid_avg <- covid_avg %>% 
  mutate(state_name = tolower(state_name))

# merge datasets
map <- us_map %>% 
  left_join(covid_avg, by = c("region" = "state_name"))

# top 10 states w/ highest death rate
top10_deaths <- map %>% 
  group_by(region) %>% 
  summarize(deaths = first(deaths),
            long = first(long),
            lat = first(lat)) %>% 
  arrange(desc(deaths)) %>% 
  slice(1:10)

# custom color palette
color_pal <- c("#504746","#b89685","#bfada3","#fbb7c0","#b6244f")

ggplot(data = map) +
  geom_polygon(mapping = aes(x = long, y = lat, group = group, fill = deaths),
               color = "white") +
  scale_fill_gradientn(colors = color_pal,
                       name = "Death Rate per 100,000") +
  geom_text(data = top10_deaths, 
            aes(x = long, y = lat, label = "*"),
            size = 6) +
  labs(title = "Spatial Trend of COVID Deaths in the US",
       subtitle = "* = Top 10 states with highest death rates")
```

The south and southeast regions consistently have higher death rates, as well as parts of the midwest.

### **8. Use a ggplot extension**

-   Pick an extension (except `cowplot`) from [here](https://exts.ggplot2.tidyverse.org/gallery/) and make a plot of your choice using the COVID data

-   You might want to try examples that come with the extension first (e.g.Â `ggtech`, `gganimate`, `ggforce`)

```{r}
#| echo: false
library(gganimate)
library(gifski)
```

```{r}
ggplot(covid_avg[!is.na(covid_avg$deaths), ]) +
geom_violin(mapping = aes(x = 1, y = deaths, fill = region_name)) +
facet_wrap(~ region_name, nrow = 2) +
labs(title = "Death Rate by Region", x = "", y = "Deaths per 100000 People") +
  transition_states(states = region_name,
                    transition_length = 2,
                    state_length = 1) +
  view_follow(fixed_y = TRUE) +
  enter_grow() +
  ease_aes('sine-in-out') +
  theme(legend.position = "none")
```
